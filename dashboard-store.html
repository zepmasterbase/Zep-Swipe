<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZepShop — Zep Swipe Marketplace (Students)</title>
  <meta name="description" content="ZepShop — student marketplace built on Base. Connect MetaMask or Coinbase Wallet to buy/sell with USDC. ZAC token for rewards." />

  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --zep-blue: #00f0ff;
      --zep-violet: #9c4dff;
      --zep-accent: linear-gradient(90deg, #00f0ff, #9c4dff);
      --bg-dark: #050018;
      --card: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.06);
      --neon-shadow: 0 6px 30px rgba(0,240,255,0.07), inset 0 -6px 22px rgba(156,77,255,0.02);
    }

    html,body{height:100%; margin:0; font-family:Poppins,system-ui; background: radial-gradient(circle at 10% 10%, #07021b, #010007 60%); color:#e6faff}
    .container{max-width:1100px; margin:28px auto; padding:18px}
    /* Header */
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--glass-border); box-shadow: var(--neon-shadow)}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:56px; height:56px; border-radius:12px; display:grid; place-items:center; font-family:Orbitron; font-weight:700; font-size:20px;
      background: linear-gradient(90deg,#00d7ff,#7f49ff); color:#030014; box-shadow:0 10px 30px rgba(0,240,255,0.12);
    }
    .brand h1{margin:0; font-family:Orbitron; letter-spacing:0.6px; font-size:20px; color:linear-gradient(#fff,#ddd)}
    .nav-actions{display:flex; gap:8px; align-items:center}
    .btn {
      border: none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; font-family:Orbitron;
    }
    .btn-ghost{ background: transparent; color:#aeefff; border:1px solid rgba(174,239,255,0.06) }
    .btn-primary{ background: linear-gradient(90deg,#00f0ff,#9c4dff); color:#050014; box-shadow:0 8px 30px rgba(156,77,255,0.06) }

    /* Top info bar */
    .info-bar{margin-top:18px; display:flex; gap:12px; align-items:center; justify-content:space-between}
    .balance-card{background:var(--card); border-radius:12px; padding:12px 16px; border:1px solid var(--glass-border); display:flex; gap:12px; align-items:center; min-width:260px}
    .balance-card strong{display:block; font-size:16px; color:#cfffff}

    /* Hero / Products grid */
    .hero{display:flex; gap:20px; margin-top:18px}
    .left{flex:1}
    .right{width:360px}
    .search{display:flex; gap:8px; margin-bottom:12px}
    .search input{flex:1; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:#e6faff}
    .products{display:grid; grid-template-columns:repeat(2,1fr); gap:14px}
    .product{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:14px; border:1px solid var(--glass-border); box-shadow:0 12px 40px rgba(0,0,0,0.4)}
    .thumb{height:100px; width:100%; border-radius:8px; background:linear-gradient(90deg,#111, #060616); display:flex; align-items:center; justify-content:center; color:#e8faff; font-weight:700; font-size:18px}
    .product h3{margin:10px 0 6px; font-size:16px; color:#ddfaff}
    .price{font-weight:800; color:#9cffff}
    .product .meta{display:flex; justify-content:space-between; align-items:center; margin-top:10px}
    .buy-btn {padding:8px 12px; border-radius:10px; background:linear-gradient(90deg,#00f0ff,#9c4dff); color:#050014; font-weight:800; cursor:pointer; border:none}

    /* Right panel (cart / details) */
    .panel{background:var(--card); border-radius:12px; padding:16px; border:1px solid var(--glass-border)}
    .panel h4{margin:0 0 8px; color:#eaffff}
    .small{font-size:13px; color:#bfefff}

    /* footer */
    footer{margin-top:30px; text-align:center; color:#95e9ff; opacity:0.7; font-size:13px}

    /* responsive */
    @media(max-width:920px){
      .products{grid-template-columns:repeat(1,1fr)}
      .hero{flex-direction:column}
      .right{width:100%}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">Z</div>
        <div>
          <div style="font-size:14px; opacity:0.95; font-family:Orbitron">ZepShop</div>
          <div style="font-size:12px; color:#9fefff; margin-top:4px">Student Marketplace — Built on Base</div>
        </div>
      </div>

      <div class="nav-actions">
        <div id="userInfo" class="balance-card" style="display:none">
          <div>
            <div style="font-size:12px; color:#9fefff">Connected</div>
            <strong id="walletShort">0x...abcd</strong>
          </div>
        </div>

        <button id="connectBtn" class="btn btn-primary">Connect Wallet</button>
        <button id="dashboardBtn" class="btn btn-ghost" style="display:none" onclick="location.href='student-dashboard.html'">Dashboard</button>
      </div>
    </header>

    <!-- Info bar: balances -->
    <div class="info-bar">
      <div style="display:flex; gap:12px">
        <div class="balance-card">
          <div>
            <div style="font-size:12px; color:#cfffff">ZAC Balance</div>
            <strong id="zacBal">— ZAC</strong>
            <div class="small">ZAC Contract on Base</div>
          </div>
        </div>

        <div class="balance-card">
          <div>
            <div style="font-size:12px; color:#cfffff">USDC Balance</div>
            <strong id="usdcBal">— USDC</strong>
            <div class="small">Used for purchases</div>
          </div>
        </div>
      </div>

      <div style="text-align:right;">
        <div style="font-size:12px; color:#cfffff">Network</div>
        <strong id="netLabel">Not connected</strong>
      </div>
    </div>

    <!-- HERO & Products -->
    <div class="hero">
      <!-- left: product listing -->
      <div class="left">
        <div class="search">
          <input id="q" placeholder="Search students' services — e.g. 'notes', 'logo', 'tutoring'">
          <button class="btn btn-primary" onclick="renderProducts()">Search</button>
        </div>

        <div class="products" id="productsGrid" aria-live="polite">
          <!-- JS injects product cards here -->
        </div>
      </div>

      <!-- right: quick cart / details -->
      <div class="right">
        <div class="panel">
          <h4>Quick Buy</h4>
          <div id="selected" style="margin:12px 0;">
            <div class="small">Select a product to buy. You will be asked to confirm a USDC transfer from your wallet.</div>
          </div>

          <div style="margin-top:12px">
            <label class="small">Buyer note (optional)</label>
            <textarea id="buyerNote" placeholder="Add a short message for the seller" style="width:100%; min-height:70px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:#e6faff"></textarea>
          </div>

          <div style="display:flex; gap:8px; margin-top:12px;">
            <button id="payBtn" class="buy-btn" disabled>Pay with USDC</button>
            <button id="previewBtn" class="btn btn-ghost" onclick="previewCart()" >Preview</button>
          </div>

          <hr style="border:none; border-top:1px solid rgba(255,255,255,0.03); margin:14px 0">

          <div class="small" style="color:#bfefff">Note: This demo uses a direct ERC-20 transfer pattern (buyer calls token.transfer → seller) — for production use a marketplace smart contract or escrow.</div>
        </div>

        <div style="height:14px"></div>

        <div class="panel" style="margin-top:12px">
          <h4>About ZepShop</h4>
          <div class="small">Student creators sell digital goods & services. Purchases are made with USDC on Base. ZAC used for rewards.</div>
        </div>
      </div>
    </div>

    <footer>
      © <span id="year"></span> ZepShop — Zep Swipe. Built on Base.
    </footer>
  </div>

  <script>
    // -----------------------
    // Configuration / constants
    // -----------------------
    const ZAC_ADDRESS = '0xfe4119a9cac1425d808526905e92386b4234bf2a'; // user's ZAC token (on Base)
    const USDC_ADDRESS = 'USDC_ON_BASE_ADDRESS'; // <<< REPLACE with real USDC contract address on Base
    const BASE_CHAIN_ID = 8453; // Base mainnet chainId

    // Example marketplace products (Fiverr-like). In production this would be dynamic from a DB.
    // Each product has: id, title, priceUSDC (in decimal USDC units; USDC typically 6 decimals), seller (address)
    const PRODUCTS = [
      { id: 'p1', title: '1-hour Tutoring: Calculus', priceUSDC: 12.00, seller: '0xSELLERADDRESS1' },
      { id: 'p2', title: 'Exam Notes — Marketing 101', priceUSDC: 5.00, seller: '0xSELLERADDRESS2' },
      { id: 'p3', title: 'Logo design (student starter pack)', priceUSDC: 15.00, seller: '0xSELLERADDRESS3' },
      { id: 'p4', title: 'Short coding gig — 1 page', priceUSDC: 8.50, seller: '0xSELLERADDRESS4' }
    ];

    // small helpers
    const formatUSDC = (v) => Number(v).toFixed(2);
    const short = (a) => a ? `${a.slice(0,6)}...${a.slice(-4)}` : '';

    // UI refs
    const connectBtn = document.getElementById('connectBtn');
    const dashboardBtn = document.getElementById('dashboardBtn');
    const userInfo = document.getElementById('userInfo');
    const walletShort = document.getElementById('walletShort');
    const zacBalEl = document.getElementById('zacBal');
    const usdcBalEl = document.getElementById('usdcBal');
    const netLabel = document.getElementById('netLabel');
    const productsGrid = document.getElementById('productsGrid');
    const selectedDiv = document.getElementById('selected');
    const payBtn = document.getElementById('payBtn');
    const previewBtn = document.getElementById('previewBtn');
    const buyerNote = document.getElementById('buyerNote');

    let provider = null;
    let signer = null;
    let currentAddress = null;
    let selectedProduct = null;

    // on load
    document.getElementById('year').textContent = new Date().getFullYear();
    renderProducts();

    // --------------------
    // Wallet connect logic
    // --------------------
    async function connectWallet() {
      try {
        if (!window.ethereum) {
          alert('No wallet detected. Please install MetaMask or open this site in Coinbase Wallet.');
          return;
        }

        // Request accounts
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = await provider.getSigner();
        currentAddress = await signer.getAddress();

        // Check network
        try {
          const net = await provider.getNetwork();
          netLabel.innerText = (net?.chainId === BASE_CHAIN_ID) ? 'Base' : `${net?.name || net?.chainId}`;
          if (net.chainId !== BASE_CHAIN_ID) {
            // Try to prompt chain switch (best-effort)
            try {
              await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0x' + BASE_CHAIN_ID.toString(16) }]
              });
              // refresh provider and signer
              provider = new ethers.BrowserProvider(window.ethereum);
              signer = await provider.getSigner();
            } catch (e) {
              console.warn('Chain switch failed or not supported in this wallet.', e);
              // user can manually switch
              netLabel.innerText = `Wrong network (please switch to Base)`;
            }
          }
        } catch(e){
          console.warn('Network check error', e);
        }

        // Save session (basic)
        localStorage.setItem('zepUser', JSON.stringify({ wallet: currentAddress, loggedIn: true, provider: 'injected' }));

        // Update UI
        walletShort.innerText = short(currentAddress);
        userInfo.style.display = 'flex';
        connectBtn.style.display = 'none';
        dashboardBtn.style.display = 'inline-flex';

        // Load balances
        await refreshBalances();

      } catch (err) {
        console.error('connectWallet err', err);
        alert('Connection failed. Please try again or use Coinbase/MetaMask mobile.');
      }
    }

    connectBtn.addEventListener('click', connectWallet);

    // load session if available
    window.addEventListener('load', async () => {
      const user = JSON.parse(localStorage.getItem('zepUser') || 'null');
      if (user && user.loggedIn && window.ethereum) {
        // try to re-hydrate
        try { await connectWallet(); } catch(e) { console.warn('rehydrate failed', e); }
      }
    });

    // -----------------------
    // Read token balances
    // -----------------------
    async function refreshBalances() {
      if (!provider || !signer) return;
      try {
        const address = await signer.getAddress();
        // ERC-20 ABI snippet
        const erc20 = ["function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)", "function symbol() view returns (string)"];

        // ZAC
        try {
          const zac = new ethers.Contract(ZAC_ADDRESS, erc20, provider);
          const [rawZac, zacSymbol] = await Promise.all([ zac.balanceOf(address), zac.symbol().catch(()=> 'ZAC') ]);
          const zacDecimals = await zac.decimals().catch(()=>18);
          const zacAmount = Number(ethers.formatUnits(rawZac, zacDecimals)).toFixed(3);
          zacBalEl.innerText = `${zacAmount} ${zacSymbol}`;
        } catch(e){ zacBalEl.innerText = '— ZAC'; console.warn('ZAC read failed', e); }

        // USDC
        if (USDC_ADDRESS === 'USDC_ON_BASE_ADDRESS') {
          usdcBalEl.innerText = 'replace USDC address';
        } else {
          try {
            const usdc = new ethers.Contract(USDC_ADDRESS, erc20, provider);
            const [rawUsdc, usdcSymbol] = await Promise.all([ usdc.balanceOf(address), usdc.symbol().catch(()=> 'USDC') ]);
            const usdcDecimals = await usdc.decimals().catch(()=>6);
            const usdcAmount = Number(ethers.formatUnits(rawUsdc, usdcDecimals)).toFixed(2);
            usdcBalEl.innerText = `${usdcAmount} ${usdcSymbol}`;
          } catch(e){ usdcBalEl.innerText = '— USDC'; console.warn('USDC read failed', e); }
        }

      } catch (err) {
        console.warn('refreshBalances err', err);
      }
    }

    // -----------------------
    // Product rendering
    // -----------------------
    function renderProducts() {
      const q = (document.getElementById('q').value || '').toLowerCase().trim();
      productsGrid.innerHTML = '';
      const items = PRODUCTS.filter(p => !q || p.title.toLowerCase().includes(q));
      items.forEach(p => {
        const el = document.createElement('div'); el.className = 'product';
        el.innerHTML = `
          <div class="thumb">SERVICE</div>
          <h3>${p.title}</h3>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div class="small">by <span style="color:#aefcff">${short(p.seller)}</span></div>
              <div class="price">USDC ${formatUSDC(p.priceUSDC)}</div>
            </div>
            <div>
              <div class="meta">
                <button class="buy-btn" onclick="selectProduct('${p.id}')">Buy</button>
              </div>
            </div>
          </div>
        `;
        productsGrid.appendChild(el);
      });
    }

    // -----------------------
    // Selection & purchase flow
    // -----------------------
    function selectProduct(id) {
      selectedProduct = PRODUCTS.find(x => x.id === id);
      selectedDiv.innerHTML = `
        <div style="display:flex; gap:12px; align-items:center;">
          <div style="flex:1">
            <div style="font-weight:800">${selectedProduct.title}</div>
            <div class="small">Seller: <span style="color:#9dffff">${short(selectedProduct.seller)}</span></div>
            <div style="margin-top:8px">Price: <strong style="color:#9cffff">USDC ${formatUSDC(selectedProduct.priceUSDC)}</strong></div>
          </div>
        </div>
      `;
      payBtn.disabled = false;
    }

    previewBtn.addEventListener('click', () => {
      if (!selectedProduct) return alert('Select a product first.');
      selectProduct(selectedProduct.id);
      alert('Preview: ' + selectedProduct.title + ' — price USDC ' + selectedProduct.priceUSDC);
    });

    // On pay: send USDC from buyer to seller (direct ERC-20 transfer). Buyer will sign transaction.
    payBtn.addEventListener('click', async () => {
      if (!selectedProduct) return alert('Choose a product first.');
      if (!signer) return alert('Connect your wallet first.');

      if (USDC_ADDRESS === 'USDC_ON_BASE_ADDRESS') {
        alert('USDC contract address not set. Replace USDC_ON_BASE_ADDRESS with the real USDC contract address on Base.');
        return;
      }

      try {
        // ERC-20 ABI small fragment (transfer)
        const erc20 = ["function transfer(address to, uint256 amount) returns (bool)", "function decimals() view returns (uint8)"];
        const usdc = new ethers.Contract(USDC_ADDRESS, erc20, signer);

        // Get decimals
        const decimals = await usdc.decimals().catch(()=>6);
        // Convert amount to token units
        const amountUnits = ethers.parseUnits(String(selectedProduct.priceUSDC), decimals);

        // Confirm & send
        const ok = confirm(`Confirm: pay USDC ${formatUSDC(selectedProduct.priceUSDC)} to seller ${short(selectedProduct.seller)}?`);
        if (!ok) return;

        payBtn.disabled = true;
        payBtn.innerText = 'Processing... (confirm in wallet)';

        const tx = await usdc.transfer(selectedProduct.seller, amountUnits);
        // wait for confirmation
        await tx.wait();

        // Optional: Persist purchase note locally (or call backend)
        const note = buyerNote.value || '';
        // For demo, we store a small local history
        const hist = JSON.parse(localStorage.getItem('zepshop_purchases')||'[]');
        hist.unshift({ productId:selectedProduct.id, txHash:tx.hash, note, time: Date.now(), buyer: currentAddress });
        localStorage.setItem('zepshop_purchases', JSON.stringify(hist));

        alert('Payment successful! TX: ' + tx.hash);
        // refresh balances
        await refreshBalances();

      } catch (err) {
        console.error('pay err', err);
        alert('Payment failed or rejected. See console for details.');
      } finally {
        payBtn.disabled = false;
        payBtn.innerText = 'Pay with USDC';
      }
    });

    // preview cart (simple)
    function previewCart(){
      if (!selectedProduct) return alert('No product selected.');
      alert(`Preview\n\n${selectedProduct.title}\nPrice: USDC ${formatUSDC(selectedProduct.priceUSDC)}\nSeller: ${short(selectedProduct.seller)}`);
    }

    // -----------------------
    // Utility: short address
    // -----------------------
    // Already defined short() earlier in top script scope

    // End
  </script>
</body>
</html>