<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zep Swipe ‚Äî Student Deals</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Poppins:wght@300;400,500,600&display=swap" rel="stylesheet">
<style>
:root{
  --zep-blue:#00f0ff;
  --zep-violet:#9c4dff;
  --bg:radial-gradient(circle at 30% 10%, #050018, #00000c);
  --glass:rgba(255,255,255,.08);
  --text-light:rgba(255,255,255,.85);
  --green:#00ff94;
  --gray:#555;
}

/* RESET */
*{box-sizing:border-box;margin:0;padding:0;font-family:Poppins,sans-serif;}
body{background:var(--bg);color:#fff;min-height:100vh;line-height:1.4;}
h2{text-align:center;font-family:Orbitron;margin:20px 0;}

/* HEADER */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 20px;
  background:rgba(0,0,0,0.2);
  backdrop-filter:blur(12px);
  border-radius:12px;
  margin:0 10px 20px;
}
.brand{font-family:Orbitron;font-size:1.6rem;background:linear-gradient(90deg,var(--zep-blue),var(--zep-violet));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.home-btn{
  width:50px;height:50px;border-radius:50%;
  background:linear-gradient(135deg,var(--zep-blue),var(--zep-violet));
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:24px;color:#050015;
  box-shadow:0 0 15px var(--zep-blue),0 0 30px var(--zep-violet);
  transition:.3s;
}
.home-btn:hover{transform:scale(1.1);}

/* FILTERS */
.filter-container{display:flex;justify-content:center;gap:10px;margin-bottom:20px;}
.filter-container select{padding:8px 12px;border-radius:12px;border:none;background:rgba(255,255,255,.05);color:#fff;}

/* DEAL CARDS */
.container{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:auto;padding:0 10px;}
@media(min-width:600px){.container{grid-template-columns:1fr 1fr;}}
@media(min-width:900px){.container{grid-template-columns:1fr 1fr 1fr;}}
.deal-card{
  background:var(--glass);
  border-radius:16px;
  padding:16px;
  border:1px solid rgba(255,255,255,.12);
  display:flex;flex-direction:column;gap:8px;
  transition:.3s;
}
.deal-card:hover{transform:translateY(-2px);box-shadow:0 0 20px rgba(0,240,255,.2),0 0 30px rgba(156,77,255,.2);}
.deal-card h3{font-family:Orbitron;margin-bottom:4px;}
.deal-card p{color:var(--text-light);font-size:.9rem;}
.deal-meta{display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-light);}
.badge{padding:4px 8px;border-radius:999px;font-size:.75rem;font-weight:600;text-transform:uppercase;}
.badge.active{background:var(--green);color:#050015;}
.badge.locked{background:var(--gray);color:#050015;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;}
.modal{background:var(--glass);padding:20px;border-radius:18px;max-width:400px;width:90%;text-align:center;box-shadow:0 0 20px var(--zep-blue),0 0 40px var(--zep-violet);}
.modal h3{margin-bottom:12px;font-family:Orbitron;}
.modal p{margin-bottom:12px;}
.modal button{padding:10px 16px;border:none;border-radius:999px;background:linear-gradient(90deg,var(--zep-blue),var(--zep-violet));color:#050015;font-family:Orbitron;cursor:pointer;transition:.3s;}
.modal button:hover{transform:translateY(-2px);box-shadow:0 0 15px var(--zep-blue),0 0 30px var(--zep-violet);}

/* LOCKED MESSAGE MODAL */
.locked-card{display:flex;flex-direction:column;align-items:center;gap:12px;}
.locked-card h3{font-family:Orbitron;}
.locked-card p{color:var(--text-light);text-align:center;}
.locked-card button{width:200px;}

/* COUNTDOWN */
.countdown{font-size:.8rem;color:var(--green);margin-top:4px;}
</style>
</head>
<body>

<header>
  <div class="brand">Zep Swipe</div>
  <div class="home-btn" title="Home" onclick="location.href='student-dashboard.html'">üè†</div>
</header>

<div class="filter-container">
  <label for="daySelect">Pick Day:</label>
  <select id="daySelect"></select>
</div>

<div class="container" id="dealsContainer"></div>

<!-- Redeem / Locked Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent">
    <div id="modalInner"></div>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
// ---------- USERS & VERIFICATION ----------
let users = JSON.parse(localStorage.getItem("users")) || {};
let currentUserId = localStorage.getItem("currentUserId");
if(!currentUserId || !users[currentUserId]) location.href="login.html";
let currentUser = users[currentUserId];

// ---------- MOCK DEALS ----------
let deals = JSON.parse(localStorage.getItem("merchantDeals")) || [
  {id:1,name:"Cafe Mocha",desc:"Free coffee with any snack",day:"Mon",lat:-1.2921,lon:36.8219},
  {id:2,name:"Tech Store",desc:"10% off student laptops",day:"Tue",lat:-1.2900,lon:36.8200},
  {id:3,name:"BookWorld",desc:"Buy 1 Get 1 free textbook",day:"Wed",lat:-1.3000,lon:36.8100},
  {id:4,name:"CinemaX",desc:"Student tickets $5",day:"Thu",lat:-1.2950,lon:36.8150},
  {id:5,name:"GymPlus",desc:"Free 1-week trial",day:"Fri",lat:-1.2850,lon:36.8250}
];

// ---------- DAYS ----------
const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const daySelect = document.getElementById("daySelect");
days.forEach(d=>{
  let opt=document.createElement("option");
  opt.value=d; opt.text=d;
  daySelect.appendChild(opt);
});
daySelect.value=days[new Date().getDay()];

// ---------- MODAL ----------
const modalOverlay = document.getElementById("modalOverlay");
const modalInner = document.getElementById("modalInner");
function showModal(content){modalInner.innerHTML=content;modalOverlay.style.display="flex";}
function closeModal(){modalOverlay.style.display="none";}

// ---------- Haversine DISTANCE ----------
function distance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c; // km
}

// ---------- REDEEM HISTORY ----------
let redeemHistory = currentUser.redeemHistory || {}; // {dealId:code}

// ---------- LOCK CHECK ----------
if(!currentUser.verified || currentUser.tasksCompleted < 5){
  showModal(`<div class="locked-card">
      <h3>Deals Locked!</h3>
      <p>Complete 5-day Learn & Earn tasks and verify your account to unlock deals.</p>
      <button onclick="location.href='learn-earn.html'">Go to Learn & Earn</button>
    </div>`);
} else {
  renderDeals();
}

// ---------- RENDER DEALS ----------
function renderDeals(){
  const container = document.getElementById("dealsContainer");
  container.innerHTML="";
  const selectedDay = daySelect.value;

  // Get user location
  navigator.geolocation.getCurrentPosition(pos=>{
    const uLat = pos.coords.latitude;
    const uLon = pos.coords.longitude;

    deals.forEach(deal=>{
      const dist = distance(uLat,uLon,deal.lat,deal.lon);
      if(deal.day!==selectedDay || dist>16.09) return; // 16.09 km ‚âà 10 miles

      const card = document.createElement("div");
      card.className="deal-card";

      let countdownId = "countdown"+deal.id;
      card.innerHTML=`
        <h3>${deal.name}</h3>
        <p>${deal.desc}</p>
        <div class="deal-meta">${deal.day} ¬∑ ${dist.toFixed(1)} km away</div>
        <div class="countdown" id="${countdownId}"></div>
        <button onclick="redeemDeal(${deal.id})">Redeem</button>
      `;
      container.appendChild(card);

      // Countdown: 3 days per deal from now
      const expiry = new Date().getTime()+3*24*60*60*1000;
      const countdownEl=document.getElementById(countdownId);
      setInterval(()=>{
        const diff = expiry - new Date().getTime();
        if(diff<0){countdownEl.innerText="Expired"; return;}
        const h=Math.floor(diff/3600000);
        const m=Math.floor((diff%3600000)/60000);
        const s=Math.floor((diff%60000)/1000);
        countdownEl.innerText=`Expires in: ${h}h ${m}m ${s}s`;
      },1000);
    });
  },()=>alert("Enable location for filtering deals within 10 miles."));
}

// ---------- REDEEM FUNCTION ----------
function redeemDeal(dealId){
  if(redeemHistory[dealId]){
    showModal(`<p>Already redeemed! Code: <strong>${redeemHistory[dealId]}</strong></p>`);
    return;
  }
  const code = `ZEP-${currentUserId}-${dealId}-${Date.now()}`;
  redeemHistory[dealId] = code;
  currentUser.redeemHistory = redeemHistory;
  users[currentUserId] = currentUser;
  localStorage.setItem("users",JSON.stringify(users));
  showModal(`<p>Redeem Code Generated!</p><p>Use in-store within 3 days:</p><strong>${code}</strong>`);
}

// ---------- DAY FILTER CHANGE ----------
daySelect.addEventListener("change",renderDeals);

</script>
</body>
</html>