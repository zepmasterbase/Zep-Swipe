<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zep Swipe ‚Äî Student Deals</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Poppins:wght@300;400,500,600&display=swap" rel="stylesheet">
<style>
:root{
  --zep-blue:#00f0ff;
  --zep-violet:#9c4dff;
  --bg:radial-gradient(circle at 30% 10%, #050018, #00000c);
  --glass:rgba(255,255,255,.08);
  --text-light:rgba(255,255,255,.85);
  --green:#00ff94;
  --gray:#555;
  --carousel-height:180px;
}

/* RESET */
*{box-sizing:border-box;margin:0;padding:0;font-family:Poppins,sans-serif;}
body{background:var(--bg);color:#fff;min-height:100vh;line-height:1.4;}
h2{text-align:center;font-family:Orbitron;margin:20px 0;}

/* HEADER */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 20px;
  background:rgba(0,0,0,0.2);
  backdrop-filter:blur(12px);
  border-radius:12px;
  margin:0 10px 20px;
}
.brand{font-family:Orbitron;font-size:1.6rem;background:linear-gradient(90deg,var(--zep-blue),var(--zep-violet));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.home-btn{
  width:50px;height:50px;border-radius:50%;
  background:linear-gradient(135deg,var(--zep-blue),var(--zep-violet));
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:24px;color:#050015;
  box-shadow:0 0 15px var(--zep-blue),0 0 30px var(--zep-violet);
  transition:.3s;
}
.home-btn:hover{transform:scale(1.1);}

/* CAROUSEL */
.carousel{
  position:relative;
  overflow:hidden;
  max-width:1200px;
  margin:0 auto 20px;
  height:var(--carousel-height);
  border-radius:16px;
}
.carousel-track{
  display:flex;
  transition:transform 0.5s ease-in-out;
}
.carousel-item{
  min-width:100%;
  flex-shrink:0;
  height:var(--carousel-height);
  border-radius:16px;
  background-size:cover;
  background-position:center;
  position:relative;
}
.carousel-item::after{
  content:'';
  position:absolute;inset:0;
  background:linear-gradient(to top, rgba(0,0,0,.5), transparent 70%);
  border-radius:16px;
}
.carousel-item h3{
  position:absolute;bottom:10px;left:16px;
  font-family:Orbitron;font-size:1.2rem;color:#fff;
  z-index:2;
}

/* CATEGORY FILTERS */
.filter-container{display:flex;justify-content:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.filter-container button{
  padding:8px 14px;border-radius:999px;border:none;
  background:rgba(255,255,255,.05);color:#fff;cursor:pointer;
  transition:.3s;font-family:Orbitron;
}
.filter-container button.active{background:linear-gradient(90deg,var(--zep-blue),var(--zep-violet));color:#050015;box-shadow:0 0 15px var(--zep-blue),0 0 25px var(--zep-violet);}
.filter-container button:hover{transform:scale(1.05);}

/* DEAL CARDS */
.container{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:auto;padding:0 10px;}
@media(min-width:600px){.container{grid-template-columns:1fr 1fr;}}
@media(min-width:900px){.container{grid-template-columns:1fr 1fr 1fr;}}
.deal-card{
  background:var(--glass);
  border-radius:16px;
  padding:16px;
  border:1px solid rgba(255,255,255,.12);
  display:flex;flex-direction:column;gap:8px;
  transition:.3s;
  position:relative;
}
.deal-card:hover{transform:translateY(-3px);box-shadow:0 0 25px var(--zep-blue),0 0 40px var(--zep-violet);}
.deal-card img{width:100%;border-radius:12px;height:120px;object-fit:cover;}
.deal-card h3{font-family:Orbitron;margin-bottom:4px;}
.deal-card p{color:var(--text-light);font-size:.9rem;}
.deal-meta{display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-light);}
.badge{padding:4px 8px;border-radius:999px;font-size:.75rem;font-weight:600;text-transform:uppercase;}
.badge.active{background:var(--green);color:#050015;}
.badge.locked{background:var(--gray);color:#050015;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;}
.modal{background:var(--glass);padding:20px;border-radius:18px;max-width:400px;width:90%;text-align:center;box-shadow:0 0 20px var(--zep-blue),0 0 40px var(--zep-violet);}
.modal h3{margin-bottom:12px;font-family:Orbitron;}
.modal p{margin-bottom:12px;}
.modal button{
  padding:10px 16px;border:none;border-radius:999px;background:linear-gradient(90deg,var(--zep-blue),var(--zep-violet));color:#050015;font-family:Orbitron;cursor:pointer;transition:.3s;
}
.modal button:hover{transform:translateY(-2px);box-shadow:0 0 15px var(--zep-blue),0 0 30px var(--zep-violet);}

/* COUNTDOWN */
.countdown{font-size:.8rem;color:var(--green);margin-top:4px;}
</style>
</head>
<body>

<header>
  <div class="brand">Zep Swipe</div>
  <div class="home-btn" title="Home" onclick="location.href='student-dashboard.html'">üè†</div>
</header>

<!-- FEATURED CAROUSEL -->
<div class="carousel" id="featuredCarousel">
  <div class="carousel-track" id="carouselTrack"></div>
</div>

<!-- CATEGORY FILTERS -->
<div class="filter-container">
  <button class="active" data-category="all">All</button>
  <button data-category="Food">üçî Food</button>
  <button data-category="Coffee">‚òï Coffee</button>
  <button data-category="Fitness">üèãÔ∏è Fitness</button>
  <button data-category="Tech">üíª Tech</button>
</div>

<!-- DEAL CARDS -->
<div class="container" id="dealsContainer"></div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent">
    <div id="modalInner"></div>
  </div>
</div>

<script>
// ---------- USERS & VERIFICATION ----------
let users = JSON.parse(localStorage.getItem("users")) || {};
let currentUserId = localStorage.getItem("currentUserId");
if(!currentUserId || !users[currentUserId]) location.href="login.html";
let currentUser = users[currentUserId];

// ---------- MOCK DEALS ----------
let deals = JSON.parse(localStorage.getItem("merchantDeals")) || [
  {id:1,name:"KFC Campus",desc:"Buy 1 Get 1 free chicken bucket",category:"Food",day:"Mon",lat:-1.2921,lon:36.8219,img:"https://i.ibb.co/2s1TVjv/kfc.jpg",campus:"Main Campus"},
  {id:2,name:"Cafe Mocha",desc:"Free coffee with any snack",category:"Coffee",day:"Mon",lat:-1.2925,lon:36.8205,img:"https://i.ibb.co/2s1TVjv/cafe.jpg",campus:"Main Campus"},
  {id:3,name:"Tech Store",desc:"10% off student laptops",category:"Tech",day:"Tue",lat:-1.2900,lon:36.8200,img:"https://i.ibb.co/1zq1zM2/tech.jpg",campus:"Tech Park"},
  {id:4,name:"BookWorld",desc:"Buy 1 Get 1 free textbook",category:"Tech",day:"Wed",lat:-1.3000,lon:36.8100,img:"https://i.ibb.co/ZmQHcmB/books.jpg",campus:"Library"},
  {id:5,name:"GymPlus",desc:"Free 1-week trial",category:"Fitness",day:"Fri",lat:-1.2850,lon:36.8250,img:"https://i.ibb.co/7b1yRZ9/gym.jpg",campus:"Sports Complex"},
  {id:6,name:"Starbucks",desc:"50% off frappuccino",category:"Coffee",day:"Thu",lat:-1.2910,lon:36.8230,img:"https://i.ibb.co/xMzrV5X/starbucks.jpg",campus:"Main Campus"}
];

// ---------- DAYS ----------
const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const daySelect = document.createElement("select"); // optional for extra day filter

// ---------- MODAL ----------
const modalOverlay = document.getElementById("modalOverlay");
const modalInner = document.getElementById("modalInner");
function showModal(content){modalInner.innerHTML=content;modalOverlay.style.display="flex";}
modalOverlay.addEventListener("click",()=>modalOverlay.style.display="none");

// ---------- Haversine DISTANCE ----------
function distance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c; // km
}

// ---------- REDEEM HISTORY ----------
let redeemHistory = currentUser.redeemHistory || {};

// ---------- LOCK CHECK ----------
if(!currentUser.verified || currentUser.tasksCompleted < 5){
  showModal(`<div style="text-align:center;">
      <h3>Deals Locked!</h3>
      <p>Complete 5-day Learn & Earn tasks and verify your account to unlock deals.</p>
      <button onclick="location.href='learn-earn.html'">Go to Learn & Earn</button>
    </div>`);
} else {
  renderDeals("all");
  renderCarousel();
}

// ---------- RENDER DEAL CARDS ----------
const dealsContainer=document.getElementById("dealsContainer");
const filterButtons=document.querySelectorAll(".filter-container button");
filterButtons.forEach(btn=>{
  btn.addEventListener("click",()=>{
    filterButtons.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    renderDeals(btn.dataset.category);
  });
});

function renderDeals(category){
  dealsContainer.innerHTML="";
  navigator.geolocation.getCurrentPosition(pos=>{
    const uLat=pos.coords.latitude,uLon=pos.coords.longitude;
    deals.forEach(deal=>{
      if(category!=="all" && deal.category!==category) return;
      const dist = distance(uLat,uLon,deal.lat,deal.lon);
      const card=document.createElement("div");
      card.className="deal-card";
      card.innerHTML=`
        <img src="${deal.img}" alt="${deal.name}">
        <h3>${deal.name}</h3>
        <p>${deal.desc}</p>
        <div class="deal-meta">${deal.day} ¬∑ ${dist.toFixed(1)} km away ¬∑ üìç ${deal.campus}</div>
        <div class="countdown" id="countdown${deal.id}"></div>
        <button onclick="redeemDeal(${deal.id})">Redeem</button>
      `;
      dealsContainer.appendChild(card);

      // Countdown: 3 days per deal
      const expiry=new Date().getTime()+3*24*60*60*1000;
      const countdownEl=document.getElementById(`countdown${deal.id}`);
      setInterval(()=>{
        const diff=expiry-new Date().getTime();
        if(diff<0){countdownEl.innerText="Expired"; return;}
        const h=Math.floor(diff/3600000);
        const m=Math.floor((diff%3600000)/60000);
        const s=Math.floor((diff%60000)/1000);
        countdownEl.innerText=`Expires in: ${h}h ${m}m ${s}s`;
      },1000);
    });
  },()=>alert("Enable location to filter deals nearby."));
}

// ---------- REDEEM FUNCTION ----------
function redeemDeal(dealId){
  if(redeemHistory[dealId]){
    showModal(`<p>Already redeemed! Code: <strong>${redeemHistory[dealId]}</strong></p>`);
    return;
  }
  const code=`ZEP-${currentUserId}-${dealId}-${Date.now()}`;
  redeemHistory[dealId]=code;
  currentUser.redeemHistory=redeemHistory;
  users[currentUserId]=currentUser;
  localStorage.setItem("users",JSON.stringify(users));
  showModal(`<p>Redeem Code Generated!</p><p>Use in-store within 3 days:</p><strong>${code}</strong>`);
}

// ---------- FEATURED CAROUSEL ----------
const carouselTrack=document.getElementById("carouselTrack");
function renderCarousel(){
  const featured=deals.slice(0,3); // top 3 featured
  featured.forEach(d=>{
    const div=document.createElement("div");
    div.className="carousel-item";
    div.style.backgroundImage=`url(${d.img})`;
    div.innerHTML=`<h3>${d.name}</h3>`;
    carouselTrack.appendChild(div);
  });
  let index=0;
  setInterval(()=>{
    index=(index+1)%featured.length;
    carouselTrack.style.transform=`translateX(-${index*100}%)`;
  },4000);
}

</script>
</body>
</html>