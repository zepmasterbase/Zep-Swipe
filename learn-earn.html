<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zep Swipe ‚Äî Learn & Earn</title>

  <!--
    learn-earn.html
    - Single-file learn & earn experience
    - Wallet-gated
    - 8 practical skills, micro-quests, capstones
    - Each quest = 25 ZAC (credited to tokens_locked immediately)
    - Pending rewards saved for later on-chain processing
    - Withdrawals disabled by default; flip WITHDRAWALS_ENABLED to true when ready
    - Keys in localStorage:
        - zepswipe_pending_rewards_v1
        - zepswipe_balance_v1
        - zepswipe_profile_v1
  -->

  <style>
    :root{
      --bg-1:#030718;
      --bg-2:#071229;
      --panel:#071426;
      --muted:#98b7d6;
      --accent-1:#8a4dff;
      --accent-2:#21d4ff;
      --glass:rgba(255,255,255,0.03);
      --card-border: rgba(255,255,255,0.03);
      --success:#10b981;
      --danger:#ef4444;
      --max-width:1200px;
    }

    /* Prevent sideways scroll */
    html,body{height:100%;overflow-x:hidden;scroll-behavior:smooth}
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      background:
        radial-gradient(700px 400px at 6% 10%, rgba(138,77,255,0.04), transparent),
        radial-gradient(600px 300px at 92% 92%, rgba(33,212,255,0.02), transparent),
        linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:#e7f2ff;
      padding:16px;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Header */
    header.site-header{
      max-width:var(--max-width); margin:0 auto; display:flex;align-items:center;justify-content:space-between;
      padding:10px 14px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px solid var(--card-border); box-shadow:0 8px 30px rgba(2,6,23,0.6);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo-3d{width:60px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:white;font-weight:900;font-size:26px;
      box-shadow:0 18px 36px rgba(138,77,255,0.14), inset 0 -6px 16px rgba(0,0,0,0.25); transform:perspective(500px) rotateX(6deg);}
    .brand-title{display:flex;flex-direction:column}
    .brand-title .name{font-size:18px;font-weight:800}
    .brand-title .tag{font-size:12px;color:var(--muted)}

    .home-cta{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid var(--card-border); box-shadow:0 12px 30px rgba(6,182,212,0.06); text-decoration:none; color:inherit;}
    .home-cta .home-icon{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:white}

    /* Layout */
    .container{max-width:var(--max-width); margin:0 auto; display:grid; grid-template-columns:320px 1fr; gap:18px; align-items:start;}
    @media (max-width:1000px){ .container{grid-template-columns:1fr;padding:8px} }

    /* Sidebar */
    aside.sidebar{background:linear-gradient(180deg,var(--panel), rgba(255,255,255,0.01)); padding:14px; border-radius:12px; border:1px solid var(--card-border); min-height:640px; display:flex;flex-direction:column;gap:12px;}
    .profile{display:flex;align-items:center;gap:12px}
    .avatar{width:62px;height:62px;border-radius:12px;background:linear-gradient(90deg,var(--accent-2),#3b82f6);display:flex;align-items:center;justify-content:center;font-size:26px;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover;border-radius:10px}
    .profile-info{display:flex;flex-direction:column}
    .profile-name{font-weight:700}
    .profile-meta{font-size:12px;color:var(--muted)}

    .stats{margin-top:6px}
    .stat-row{display:flex;justify-content:space-between;padding:8px 4px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px}
    .progress{margin-top:8px;height:10px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));width:0%}

    nav.nav{margin-top:8px}
    nav.nav ul{list-style:none}
    nav.nav li{padding:10px;border-radius:8px;color:var(--muted);cursor:pointer}
    nav.nav li:hover{background:rgba(255,255,255,0.02);color:#e6eef8}

    .connect-row{display:flex;justify-content:space-between;align-items:center;margin-top:auto}

    /* Main panel */
    main.panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:14px; border-radius:12px; border:1px solid var(--card-border); min-height:640px; overflow:auto; -webkit-overflow-scrolling:touch;}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr} }

    .card{background:transparent;padding:12px;border-radius:10px;border:1px solid var(--card-border)}
    .section-title{display:flex;justify-content:space-between;align-items:center}
    .muted{color:var(--muted);font-size:13px}

    /* skills, quests */
    .skills{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    @media (max-width:800px){ .skills{grid-template-columns:repeat(2,1fr)} }
    .skill{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid var(--card-border)}
    .skill .title{font-weight:700;font-size:14px}
    .skill .desc{font-size:12px;color:var(--muted);margin-top:6px}
    .skill .actions{display:flex;gap:8px;margin-top:10px}

    .quests{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    @media (max-width:1000px){ .quests{grid-template-columns:repeat(1,1fr)} }
    .quest{padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid var(--card-border)}

    .pending-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .pending-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}

    input[type="file"]{color:var(--muted);font-size:13px}

    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .small{padding:6px 8px;border-radius:8px}

    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;font-weight:700;font-size:13px}

    footer.page-foot{max-width:var(--max-width);margin:0 auto;padding:8px 14px;color:var(--muted);font-size:13px;text-align:center}

    /* gate overlay */
    .gate-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,23,0.78), rgba(2,6,23,0.86));backdrop-filter:blur(6px);z-index:9999}
    .gate-card{width:min(720px,94%);background:linear-gradient(180deg,#081428,#071226);border:1px solid rgba(255,255,255,0.04);padding:26px;border-radius:12px;text-align:center}
    .gate-title{font-size:20px;font-weight:800;margin-bottom:8px}
    .gate-desc{color:var(--muted);margin-bottom:18px}
    .connect-large{padding:12px 18px;border-radius:10px;font-weight:700;font-size:15px;cursor:pointer}
    .connect-primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;border:none}
    .connect-secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);margin-left:10px}

    /* keep UI tight on small screens */
    @media (max-width:600px){
      .logo-3d{width:50px;height:50px;font-size:22px}
      .avatar{width:54px;height:54px}
      .gate-card{padding:18px}
      .skills{grid-template-columns:repeat(2,1fr)}
      .quests{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header" role="banner">
    <div class="brand" aria-hidden="true">
      <div class="logo-3d">Z</div>
      <div class="brand-title">
        <div class="name">Zep Swipe</div>
        <div class="tag muted">Learn ¬∑ Prove ¬∑ Earn</div>
      </div>
    </div>

    <a class="home-cta" href="dashboard-student.html" title="Home" aria-label="Go to dashboard">
      <div class="home-icon" aria-hidden="true">üè†</div>
    </a>
  </header>

  <!-- APP -->
  <div id="appRoot" class="container" aria-hidden="true">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Sidebar">
      <div class="profile">
        <div id="sideAvatar" class="avatar" aria-hidden="true">üë©üèæ‚Äçüíª</div>
        <div class="profile-info">
          <div id="displayName" class="profile-name">Student</div>
          <div id="displayUni" class="profile-meta">University</div>
        </div>
      </div>

      <div class="stats" aria-hidden="true">
        <div class="stat-row"><div>XP</div><div id="xp">0</div></div>
        <div class="stat-row"><div>ZAC (avail/locked)</div><div id="tokens">0 / locked 0</div></div>
        <div class="stat-row"><div>Badges</div><div id="badgeCount">0</div></div>
        <div class="progress"><i id="progressFill"></i></div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <ul>
          <li id="nav-home">Home</li>
          <li id="nav-skills">Skills</li>
          <li id="nav-quests">Quests</li>
          <li id="nav-market">Marketplace</li>
          <li id="nav-rewards">Rewards</li>
          <li id="nav-profile">Profile</li>
        </ul>
      </nav>

      <div class="connect-row" style="margin-top:auto">
        <div style="font-size:13px;color:var(--muted)">Wallet</div>
        <button id="connectBtn" class="btn btn-primary">Connect</button>
      </div>

      <div style="margin-top:10px">
        <div class="muted" style="font-size:13px">Store Access</div>
        <div id="storeGate" style="margin-top:8px"></div>
      </div>

      <div style="margin-top:10px">
        <div class="muted" style="font-size:13px">Pending Rewards</div>
        <div id="pendingPreview" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="panel" role="main">
      <div class="grid">
        <!-- LEFT: skills & quests -->
        <div>
          <div class="card">
            <div class="section-title">
              <div>
                <div style="font-weight:800">Skill Tracks (Practical)</div>
                <div class="muted" style="font-size:13px">Complete micro-quests, pass capstones, earn badges</div>
              </div>
              <div><button id="resetProgress" class="btn btn-ghost small">Reset</button></div>
            </div>

            <div class="skills" id="skillsGrid" aria-live="polite"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <div class="section-title">
              <div>
                <div style="font-weight:800">Quests (Practical Tests)</div>
                <div class="muted" style="font-size:13px">Each practical test gives <strong>25 ZAC</strong> and XP ‚Äî tokens initially locked</div>
              </div>
              <div><button id="unlockAll" class="btn btn-ghost small">Unlock All</button></div>
            </div>

            <div class="quests" id="questsContainer" aria-live="polite"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <div class="section-title">
              <div>
                <div style="font-weight:800">Capstones & Certification</div>
                <div class="muted" style="font-size:13px">Pass capstones to earn on-platform badges</div>
              </div>
              <div><button id="viewCerts" class="btn btn-ghost small">View</button></div>
            </div>

            <div id="certsArea" style="margin-top:12px"></div>
          </div>
        </div>

        <!-- RIGHT: marketplace & pending -->
        <div>
          <div class="card">
            <div class="section-title">
              <div>
                <div style="font-weight:800">Marketplace Preview</div>
                <div class="muted" style="font-size:13px">Create gigs based on certified skills</div>
              </div>
              <div><button id="browseMarket" class="btn btn-ghost small">Open</button></div>
            </div>

            <div id="marketList" style="margin-top:12px"></div>

            <!-- Global Freelancer CTA placeholder -->
            <div id="globalFreelancerArea" style="margin-top:12px"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <div class="section-title">
              <div>
                <div style="font-weight:800">Pending Rewards</div>
                <div class="muted" style="font-size:13px">Queued rewards ‚Äî claim to wallet later or process via relayer</div>
              </div>
              <div><button id="processAllRelayer" class="btn btn-ghost small">Process Relayer</button></div>
            </div>

            <div class="pending-list" id="pendingList"></div>
            <div style="margin-top:10px" class="muted">Tip: Withdrawals are locked until your token & contract are live; tokens are shown as locked.</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <footer class="page-foot">Zep Swipe ‚Äî Learn ‚Ä¢ Prove ‚Ä¢ Earn ‚Äî Local mode (swap to backend/contract when ready)</footer>

  <!-- ethers (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

  <!-- Wallet Gate -->
  <div id="gateOverlay" class="gate-overlay" style="display:none;">
    <div class="gate-card">
      <div class="gate-title">Connect your wallet to continue</div>
      <div class="gate-desc">Your wallet is your identity for Learn & Earn. Connect to access training, earn locked ZAC, and claim later.</div>
      <div style="display:flex;justify-content:center;gap:10px;margin-top:18px">
        <button id="gateConnect" class="connect-large connect-primary">Connect Wallet</button>
        <button id="gateCancel" class="connect-large connect-secondary">Back to Dashboard</button>
      </div>
    </div>
  </div>

  <script>
  /************************************************************************
   * Zep Swipe ‚Äî learn-earn.html (complete)
   * - All logic client-side (localStorage) for prototyping and community building.
   * - Update CONTRACT_ADDRESS and CONTRACT_ABI to enable on-chain claims.
   * - Flip WITHDRAWALS_ENABLED to true to enable claim flows (after token launch).
   ************************************************************************/

  /* ---------- Flags & config ---------- */
  const PENDING_KEY = 'zepswipe_pending_rewards_v1';
  const BAL_KEY     = 'zepswipe_balance_v1';
  const PROFILE_KEY = 'zepswipe_profile_v1';
  const XP_THRESHOLD_STORE = 200;

  // Smart contract placeholder ‚Äî set when ready
  const CONTRACT_ADDRESS = ""; // e.g. "0x..."
  const CONTRACT_ABI = [];     // your contract ABI
  const DEMO_SIMULATE_ONCHAIN_IF_NO_CONTRACT = true;

  // Keep withdrawals locked until token & contract are ready
  const WITHDRAWALS_ENABLED = false;

  /* ---------- Content ---------- */
  const SKILLS = [
    { id:'s1', title:'AI Prompt Engineering', short:'Prompt design & prompt chains' },
    { id:'s2', title:'AI Content Generation', short:'Long-form & social content' },
    { id:'s3', title:'Social Design (No-code)', short:'Carousels, flyers, templates' },
    { id:'s4', title:'Chatbot Builder', short:'Conversational flows & automations' },
    { id:'s5', title:'No-code Websites', short:'Landing pages & forms' },
    { id:'s6', title:'Micro Video Editor', short:'Short edits & captions' },
    { id:'s7', title:'Research & Lead Gen', short:'Data lists & clean CSVs' },
    { id:'s8', title:'Micro-Automation', short:'Zapier-like workflows' },
  ];

  // Practical tests = 25 ZAC each; keep keywords to help verification
  const QUESTS = [
    { id:'q1', title:'Intro to AI Tools', desc:'Write a 1-line prompt summarizing a task.', xp:50, tokens:25, keywords:['prompt','task'] },
    { id:'q2', title:'Prompt Crafting', desc:'Refine that prompt into 3 actionable steps.', xp:80, tokens:25, keywords:['steps','action'] },
    { id:'q3', title:'Design Carousel', desc:'Describe a 3-card social carousel concept.', xp:70, tokens:25, keywords:['carousel','card','social'] },
    { id:'q4', title:'Chat Flow', desc:'Map 3 conversation flows for a small business.', xp:90, tokens:25, keywords:['flow','conversation','bot'] }
  ];

  const GIGS = [
    { id:'g1', title:'Write 5 Captions Pack', tokens:25, eta:'1 day' },
    { id:'g2', title:'Promo Flyer Design', tokens:25, eta:'2 days' },
    { id:'g3', title:'Small Business Chatbot', tokens:25, eta:'3 days' }
  ];

  /* ---------- Storage utilities ---------- */
  function readPending(){ try{ return JSON.parse(localStorage.getItem(PENDING_KEY)) || []; }catch(e){ return []; } }
  function writePending(arr){ localStorage.setItem(PENDING_KEY, JSON.stringify(arr)); renderPending(); renderPendingPreview(); renderStoreGate(); }
  function readBalance(){
    try{
      // new shape includes tokens_available and tokens_locked
      return JSON.parse(localStorage.getItem(BAL_KEY)) || { xp:0, tokens_available:0, tokens_locked:0, completed:{} };
    }catch(e){ return { xp:0, tokens_available:0, tokens_locked:0, completed:{} }; }
  }
  function writeBalance(b){ localStorage.setItem(BAL_KEY, JSON.stringify(b)); renderBalance(); renderQuests(); renderCerts(); renderStoreGate(); }
  function readProfile(){ try{ return JSON.parse(localStorage.getItem(PROFILE_KEY)) || { badges:[], name:'Student', university:'University', avatar:'' }; }catch(e){ return { badges:[], name:'Student', university:'University', avatar:'' }; } }
  function writeProfile(p){ localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); renderCerts(); renderStoreGate(); renderProfileHeader(); }

  function genId(){ return 'r_' + Math.random().toString(36).slice(2,9); }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  /* ---------- Wallet gate ---------- */
  let provider = null, signer = null, userAddr = null;

  async function checkWalletConnected(){
    if(!window.ethereum) return false;
    try{
      provider = new ethers.BrowserProvider(window.ethereum);
      const accounts = await provider.send('eth_accounts', []);
      if(accounts && accounts.length > 0){
        signer = await provider.getSigner();
        userAddr = accounts[0];
        return true;
      }
      return false;
    }catch(e){ console.debug('checkWalletConnected', e); return false; }
  }

  async function connectWallet(){
    if(!window.ethereum){ alert('No Web3 wallet found. Install MetaMask or a compatible wallet.'); return false; }
    try{
      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      signer = await provider.getSigner();
      userAddr = await signer.getAddress();
      document.getElementById('connectBtn').textContent = 'Connected';
      document.getElementById('displayName').textContent = userAddr.slice(0,6) + '...' + userAddr.slice(-4);
      hideGate();
      return true;
    }catch(e){ console.error('connectWallet', e); return false; }
  }

  function cancelGate(){ window.location.href = 'dashboard-student.html'; }

  function showGate(){ document.getElementById('gateOverlay').style.display = 'flex'; document.getElementById('appRoot').setAttribute('aria-hidden', 'true'); }
  function hideGate(){ document.getElementById('gateOverlay').style.display = 'none'; document.getElementById('appRoot').removeAttribute('aria-hidden'); initializeUI(); }

  document.getElementById('gateConnect').addEventListener('click', async ()=> { await connectWallet(); });
  document.getElementById('gateCancel').addEventListener('click', cancelGate);
  document.getElementById('connectBtn').addEventListener('click', async ()=> { await connectWallet(); });

  /* ---------- Rendering ---------- */
  function renderProfileHeader(){
    const p = readProfile();
    document.getElementById('displayName').textContent = userAddr ? (userAddr.slice(0,6)+'...'+userAddr.slice(-4)) : (p.name || 'Student');
    document.getElementById('displayUni').textContent = p.university || '';
    const sideAvatar = document.getElementById('sideAvatar'); sideAvatar.innerHTML = '';
    if(p.avatar){
      const img = document.createElement('img'); img.src = p.avatar; img.alt = p.name || 'avatar'; sideAvatar.appendChild(img);
    } else {
      sideAvatar.textContent = 'üë©üèæ‚Äçüíª';
    }
  }

  function renderSkills(){
    const root = document.getElementById('skillsGrid'); root.innerHTML = '';
    const profile = readProfile();
    SKILLS.forEach(s=>{
      const hasBadge = (profile.badges || []).some(b=>b.skillId===s.id);
      const el = document.createElement('div'); el.className = 'skill';
      el.innerHTML = `<div class="title">${s.title}${hasBadge? ' ‚Ä¢ <span style="font-weight:700;color:var(--accent-2);font-size:12px">Certified</span>':''}</div>
        <div class="desc">${s.short}</div>
        <div class="actions">
          <button class="btn small btn-primary" onclick="openSkill('${s.id}')">${hasBadge? 'Practice' : 'Start'}</button>
          <button class="btn small btn-ghost" onclick="previewSkill('${s.id}')">Syllabus</button>
          <button class="btn small btn-ghost" onclick="promptTakeCapstone('${s.id}')">Capstone</button>
        </div>`;
      root.appendChild(el);
    });
  }

  function renderQuests(){
    const root = document.getElementById('questsContainer'); root.innerHTML = '';
    const b = readBalance(); const completed = b.completed || {};
    QUESTS.forEach((q, idx)=>{
      const unlocked = idx === 0 || !!completed[QUESTS[idx-1].id];
      const done = !!completed[q.id];
      const el = document.createElement('div'); el.className = 'quest';
      el.innerHTML = `<h3>${q.title} ${done?'<span style="color:var(--success)">‚úÖ</span>':''}</h3>
        <div class="meta">${q.desc}</div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
          <button class="btn small ${unlocked? 'btn-primary':''}" ${unlocked? '':'disabled'} onclick="openQuest('${q.id}')">${unlocked?'Open':'Locked'}</button>
          <button class="btn small btn-ghost" ${done? 'disabled':''} onclick="submitQuest('${q.id}')">Submit</button>
          <div style="margin-left:auto;font-size:13px;color:var(--muted)">Reward: ${q.xp} XP ‚Ä¢ ${q.tokens} ZAC</div>
        </div>`;
      root.appendChild(el);
    });
  }

  function renderMarket(){
    const root = document.getElementById('marketList'); root.innerHTML = '';
    const profile = readProfile(); const badges = profile.badges || [];
    GIGS.forEach(g=>{
      const el = document.createElement('div'); el.className = 'gig';
      el.innerHTML = `<div><div style="font-weight:700">${g.title}</div><div class="muted" style="font-size:13px">ETA: ${g.eta}</div></div>
        <div style="text-align:right"><div style="font-weight:700">${g.tokens} ZAC</div>
        <div style="margin-top:8px">${badges.length>0 ? '<button class="btn small btn-primary" onclick="createGigFromBadge()">Create Gig</button>' : '<div class="muted">Requires certification</div>'}</div></div>`;
      root.appendChild(el);
    });
    renderGlobalFreelancerCTA();
  }

  function renderPending(){
    const root = document.getElementById('pendingList'); root.innerHTML = '';
    const pending = readPending();
    if(pending.length === 0){ root.innerHTML = '<div class="muted">No pending rewards</div>'; return; }
    pending.forEach(p=>{
      const el = document.createElement('div'); el.className = 'pending-item';
      el.innerHTML = `<div>
          <div style="font-weight:700">${p.questTitle} <span class="badge" style="margin-left:8px">${p.tokens} Z</span></div>
          <div class="muted" style="font-size:12px">Created: ${new Date(p.createdAt).toLocaleString()} ‚Ä¢ ${p.status}</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn small btn-primary" onclick="claimWithWallet('${p.id}')" ${p.status!=='pending'?'disabled':''}>Claim (Wallet)</button>
          <button class="btn small btn-ghost" onclick="simulateRelayer('${p.id}')" ${p.status!=='pending'?'disabled':''}>Process (Relayer)</button>
          <button class="btn small btn-ghost" onclick="forfeitPending('${p.id}')">Forfeit</button>
        </div>`;
      root.appendChild(el);
    });
  }

  function renderPendingPreview(){
    const cont = document.getElementById('pendingPreview'); cont.innerHTML = '';
    readPending().slice(0,4).forEach(p=>{
      const d = document.createElement('div'); d.style.padding='6px 10px'; d.style.borderRadius='10px'; d.style.background='rgba(255,255,255,0.02)'; d.style.fontSize='12px';
      d.textContent = `${p.questTitle.split(' ')[0]} ‚Ä¢ ${p.tokens}Z`; cont.appendChild(d);
    });
  }

  function renderCerts(){
    const area = document.getElementById('certsArea'); area.innerHTML = '';
    const profile = readProfile();
    if((profile.badges || []).length === 0){ area.innerHTML = '<div class="muted">No badges yet. Take a capstone to certify.</div>'; document.getElementById('badgeCount').textContent = '0'; return; }
    profile.badges.forEach(b=>{
      const el = document.createElement('div'); el.style.marginBottom='8px';
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><div style="font-weight:700">${b.skillTitle}</div><div class="muted" style="font-size:12px">Issued: ${new Date(b.issuedAt).toLocaleDateString()}</div></div>
        <div><span class="badge">Certified</span></div>
      </div>`;
      area.appendChild(el);
    });
    document.getElementById('badgeCount').textContent = String((profile.badges||[]).length);
    renderGlobalFreelancerCTA();
  }

  function renderBalance(){
    const b = readBalance();
    const available = b.tokens_available || 0;
    const locked = b.tokens_locked || 0;
    document.getElementById('xp').textContent = b.xp || 0;
    document.getElementById('tokens').innerHTML = `${available} <span style="opacity:.7">/ locked ${locked}</span>`;
    const done = Object.keys(b.completed || {}).length;
    const pct = Math.round((done / QUESTS.length) * 100);
    document.getElementById('progressFill').style.width = pct + '%';
  }

  function renderStoreGate(){
    const el = document.getElementById('storeGate'); el.innerHTML = '';
    const profile = readProfile(); const bal = readBalance();
    const hasBadge = (profile.badges || []).length > 0;
    const hasXP = (bal.xp || 0) >= XP_THRESHOLD_STORE;
    if(hasBadge || hasXP){
      const a = document.createElement('a');
      a.href = 'dashboard-store.html';
      a.textContent = 'Open Store ‚Üí';
      a.style.cssText = 'display:inline-block;padding:8px 12px;border-radius:8px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;text-decoration:none;font-weight:700';
      el.appendChild(a);
    } else {
      el.innerHTML = `<div class="muted" style="font-size:13px">Locked ‚Äî earn a badge or reach ${XP_THRESHOLD_STORE} XP</div>`;
    }
  }

  /* ---------- Global Freelancer CTA ---------- */
  function renderGlobalFreelancerCTA(){
    const container = document.getElementById('globalFreelancerArea');
    if(!container) return;
    container.innerHTML = '';
    const profile = readProfile();
    const badgeCount = (profile.badges || []).length;
    // show CTA only if user has all SKILLS certified
    if(badgeCount >= SKILLS.length){
      const a = document.createElement('a');
      a.href = 'dashboard-store.html';
      a.className = 'btn btn-primary';
      a.style.display = 'inline-block';
      a.style.padding = '10px 14px';
      a.style.borderRadius = '10px';
      a.textContent = 'Global Freelancer ‚Äî Open Store';
      container.appendChild(a);
    }
  }

  /* ---------- Submission verification ---------- */
  function verifySubmission(quest, text){
    const minChars = 40;
    if(!text || text.trim().length < minChars) return { ok:false, reason:`Write at least ${minChars} characters.` };
    if(quest.keywords && quest.keywords.length){
      const lower = text.toLowerCase();
      const found = quest.keywords.some(k => lower.includes(k.toLowerCase()));
      if(!found) return { ok:false, reason:`Include at least one relevant keyword (e.g. ${quest.keywords.slice(0,2).join(', ')})` };
    }
    return { ok:true };
  }

  /* ---------- Actions & flows ---------- */
  window.openSkill = function(skillId){ alert('Open learning tool for ' + skillId + ' ‚Äî integrate your course player here.'); };
  window.previewSkill = function(skillId){
    const s = SKILLS.find(x=>x.id===skillId);
    alert(`${s.title}\n\n${s.short}\n\nStructure: 4 micro-quests ‚Üí 1 capstone ‚Üí badge ‚Üí gigs`);
  };
  window.createGigFromBadge = function(){ alert('Open create gig flow (demo).'); };

  // openQuest uses a small modal to capture submission text + optional file
  window.openQuest = function(qid){
    const q = QUESTS.find(x=>x.id===qid); if(!q) return;
    const modal = document.createElement('div');
    modal.style.position='fixed'; modal.style.inset='0'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex=99999;
    modal.style.background='linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.7))';

    modal.innerHTML = `
      <div style="width:min(720px,94%);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);">
        <div style="font-weight:800;font-size:16px;margin-bottom:8px">${q.title}</div>
        <div style="color:var(--muted);margin-bottom:12px">${q.desc}</div>
        <textarea id="zep_submission_text" rows="6" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:inherit" placeholder="Write your submission..."></textarea>
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <input id="zep_submission_file" type="file" accept="image/*,video/*,.pdf,.txt" />
          <div style="margin-left:auto;display:flex;gap:8px">
            <button id="zep_cancel_btn" class="btn btn-ghost small">Cancel</button>
            <button id="zep_submit_btn" class="btn btn-primary small">Submit</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    document.getElementById('zep_cancel_btn').onclick = ()=> modal.remove();
    document.getElementById('zep_submit_btn').onclick = async ()=>{
      const text = document.getElementById('zep_submission_text').value || '';
      const fileInput = document.getElementById('zep_submission_file');
      let fileDataUrl = null;
      if(fileInput && fileInput.files && fileInput.files[0]){
        fileDataUrl = await toDataURL(fileInput.files[0]);
      }
      const ok = verifySubmission(q, text);
      if(!ok.ok){ alert('Submission error: ' + ok.reason); return; }
      submitQuest(qid, text, fileDataUrl);
      modal.remove();
    };
  };

  // helper to convert file to dataURL
  function toDataURL(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // submitQuest: immediate credit to XP and tokens_locked, plus pending record for later on-chain processing
  function submitQuest(qid, submissionText = '', fileDataUrl = ''){
    const bal = readBalance(); bal.completed = bal.completed || {};
    if(bal.completed[qid]) return alert('Quest already completed.');
    // mark quest completed
    bal.completed[qid] = { when: Date.now(), submission: submissionText, file: !!fileDataUrl };

    // award XP now
    const q = QUESTS.find(x=>x.id===qid);
    bal.xp = (bal.xp || 0) + (q.xp || 0);

    // credit tokens to locked bucket immediately
    bal.tokens_locked = (bal.tokens_locked || 0) + (q.tokens || 0);

    writeBalance(bal);

    // create pending reward record (for admin/relayer/on-chain later)
    const pending = readPending();
    const item = {
      id: genId(),
      questId: qid,
      questTitle: q.title,
      xp: q.xp,
      tokens: q.tokens,
      createdAt: Date.now(),
      status: 'pending',
      claimedAt: null,
      evidence: { text: submissionText.slice(0,300), file: !!fileDataUrl }
    };
    pending.push(item);
    writePending(pending);

    alert(`Submission received ‚Äî ${q.xp} XP and ${q.tokens} ZAC credited (locked). Withdrawals are disabled for now.`);
    renderQuests(); renderPending(); renderPendingPreview(); renderBalance();
  }
  window.submitQuest = submitQuest;

  /* ---------- Claim flows (wallet or relayer) ---------- */
  async function claimWithWallet(rewardId){
    if(!WITHDRAWALS_ENABLED){
      return alert('Withdrawals are currently disabled. Earned ZAC is visible and locked until launch.');
    }

    const pending = readPending(); const item = pending.find(p=>p.id===rewardId);
    if(!item) return alert('Pending reward not found.');
    if(!CONTRACT_ADDRESS || CONTRACT_ABI.length === 0){
      if(DEMO_SIMULATE_ONCHAIN_IF_NO_CONTRACT){
        await sleep(700); markPendingClaimedLocally(item); alert('(Simulated) Claimed to wallet.');
        return;
      } else {
        alert('On-chain claim not configured. Contact admin.');
        return;
      }
    }
    try{
      if(!signer){ await connectWallet(); if(!signer) return; }
      const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
      let tx;
      try { tx = await contract.claimReward(item.id); } catch(e1){
        try { tx = await contract.claimReward(ethers.utils.formatBytes32String(item.id)); } catch(e2){
          throw new Error('Contract claim call failed ‚Äî check ABI');
        }
      }
      alert('Transaction sent ‚Äî waiting for confirmation');
      await tx.wait();
      markPendingClaimedLocally(item);
      alert('On-chain claim confirmed. Local balance updated.');
    }catch(e){ console.error(e); alert('Claim failed: ' + (e.message || e)); }
  }
  window.claimWithWallet = claimWithWallet;

  async function simulateRelayer(rewardId){
    const pending = readPending(); const item = pending.find(p=>p.id===rewardId);
    if(!item) return alert('Pending reward not found.');
    if(!confirm('Simulate relayer processing this reward now?')) return;
    await sleep(700);
    // For demo/local flow, we still mark claimed locally ‚Äî in production relayer would perform on-chain transfer then update DB
    markPendingClaimedLocally(item);
    alert('Relayer processed (simulated). Local balances updated.');
  }
  window.simulateRelayer = simulateRelayer;

  function forfeitPending(id){
    if(!confirm('Forfeit this pending reward?')) return;
    const pending = readPending().map(p => p.id === id ? {...p, status:'forfeited'} : p);
    writePending(pending);
  }
  window.forfeitPending = forfeitPending;

  // marks pending as claimed and moves tokens from locked -> available (if you want to make available instead of removing)
  function markPendingClaimedLocally(item){
    const bal = readBalance();
    // decrease locked; increase available only if you want to track available tokens (we keep them available for eventual withdrawal)
    bal.tokens_locked = Math.max(0, (bal.tokens_locked || 0) - item.tokens);
    bal.tokens_available = (bal.tokens_available || 0) + item.tokens;
    bal.xp = (bal.xp || 0) + 0; // xp already added on submission
    writeBalance(bal);
    const pending = readPending().map(p => p.id === item.id ? {...p, status:'claimed', claimedAt:Date.now()} : p);
    writePending(pending);
    checkAutoCertifications();
  }

  document.getElementById('processAllRelayer').addEventListener('click', async ()=>{
    const pending = readPending().filter(p=>p.status==='pending'); if(pending.length===0) return alert('No pending rewards to process.');
    if(!confirm(`Simulate relayer processing ${pending.length} pending items?`)) return;
    for(const p of pending){ await sleep(250); markPendingClaimedLocally(p); }
    alert('All pending processed (simulated).');
  });

  /* ---------- Capstones & certification ---------- */
  function takeCapstoneForSkill(skillId){
    const bal = readBalance(); const completedCount = Object.keys(bal.completed || {}).length;
    if(completedCount < 1) return alert('Complete at least one quest to attempt a capstone.');
    if(!confirm('Submit capstone for review? (Automatic pass in this flow)')) return;
    const profile = readProfile();
    if(profile.badges && profile.badges.find(x=>x.skillId===skillId)) return alert('You already have this badge.');
    const skill = SKILLS.find(s=>s.id===skillId);
    const badge = { id: genId(), skillId, skillTitle: skill.title, issuedAt: Date.now(), evidence: [] };
    profile.badges = profile.badges || []; profile.badges.push(badge); writeProfile(profile);
    // small reward for certification
    const bal2 = readBalance(); bal2.xp += 40; bal2.tokens_locked = (bal2.tokens_locked || 0) + 4; writeBalance(bal2);
    alert(`Badge issued: ${skill.title}. Small certification reward credited (locked).`);
  }
  window.takeCapstoneForSkill = takeCapstoneForSkill;

  function promptTakeCapstone(skillId){
    if(!confirm('Attempt capstone?')) return; takeCapstoneForSkill(skillId);
  }
  window.promptTakeCapstone = promptTakeCapstone;

  function checkAutoCertifications(){
    const bal = readBalance(); const profile = readProfile();
    if(bal.xp >= XP_THRESHOLD_STORE && (!profile.badges || profile.badges.length === 0)){
      const badge = { id: genId(), skillId: 'platform', skillTitle: 'Platform Certified', issuedAt: Date.now(), evidence: [] };
      profile.badges = profile.badges || []; profile.badges.push(badge); writeProfile(profile);
      alert('Auto-certification: Platform Certified (XP threshold reached).');
    }
    renderGlobalFreelancerCTA();
  }

  /* ---------- UI helpers ---------- */
  document.getElementById('unlockAll').addEventListener('click', ()=>{
    const b = readBalance(); QUESTS.forEach(q => b.completed[q.id] = { when: Date.now() }); writeBalance(b); alert('All quests unlocked (dev).');
  });
  document.getElementById('browseMarket').addEventListener('click', ()=> window.location.href = 'dashboard-store.html');
  document.getElementById('resetProgress').addEventListener('click', ()=>{
    if(!confirm('Reset local demo data? This clears badges, balances and pending rewards.')) return;
    localStorage.removeItem(PENDING_KEY); localStorage.removeItem(BAL_KEY); localStorage.removeItem(PROFILE_KEY); init(); alert('Local data cleared.');
  });
  document.getElementById('viewCerts').addEventListener('click', ()=>{
    const profile = readProfile(); if(!profile.badges || profile.badges.length === 0) return alert('No badges yet.'); let s='Badges:\\n'; profile.badges.forEach(b=> s+=`‚Ä¢ ${b.skillTitle} ‚Äî ${new Date(b.issuedAt).toLocaleDateString()}\\n`); alert(s);
  });

  /* ---------- optional: import profile from profile.html script tag ---------- */
  async function tryFetchProfileFromProfileHtml(){
    try{
      const res = await fetch('profile.html', {cache: 'no-store'});
      if(!res.ok) return;
      const text = await res.text();
      const markerStart = '<script id="zep-profile-json"';
      const idx = text.indexOf(markerStart); if(idx === -1) return;
      const startTag = text.indexOf('>', idx) + 1; const endTag = text.indexOf('</script>', startTag);
      if(startTag === -1 || endTag === -1) return;
      const jsonText = text.slice(startTag, endTag).trim(); if(!jsonText) return;
      const profile = JSON.parse(jsonText); if(profile) writeProfile(profile);
    }catch(e){ /* ignore */ }
  }

  /* ---------- initialize UI & storage ---------- */
  function initializeUI(){
    renderProfileHeader(); renderSkills(); renderQuests(); renderMarket(); renderPending(); renderPendingPreview(); renderBalance(); renderCerts(); renderStoreGate();
  }

  async function init(){
    // Seed storage shape if missing
    if(!localStorage.getItem(BAL_KEY)) localStorage.setItem(BAL_KEY, JSON.stringify({ xp:0, tokens_available:0, tokens_locked:0, completed:{} }));
    if(!localStorage.getItem(PENDING_KEY)) localStorage.setItem(PENDING_KEY, JSON.stringify([]));
    if(!localStorage.getItem(PROFILE_KEY)) localStorage.setItem(PROFILE_KEY, JSON.stringify({ badges:[], name:'Student', university:'University', avatar:'' }));

    // optional: try to load enriched profile from profile.html (non-blocking)
    tryFetchProfileFromProfileHtml();

    // check wallet
    const connected = await checkWalletConnected();
    if(!connected){
      showGate();
    } else {
      document.getElementById('connectBtn').textContent = 'Connected';
      hideGate();
    }

    initializeUI();
  }

  // expose functions for inline handlers
  window.openSkill = openSkill; window.previewSkill = previewSkill; window.openQuest = openQuest;
  window.submitQuest = submitQuest; window.claimWithWallet = claimWithWallet; window.simulateRelayer = simulateRelayer;
  window.forfeitPending = forfeitPending; window.createGigFromBadge = createGigFromBadge;

  init();
  </script>
</body>
</html>