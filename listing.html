<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZepShop — Listing</title>
  <meta name="description" content="ZepShop — student marketplace listing page. Buy digital services with USDC on Base." />

  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --zep-blue: #00f0ff;
      --zep-violet: #9c4dff;
      --bg-dark: #050018;
      --card: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.06);
      --neon-shadow: 0 6px 30px rgba(0,240,255,0.07), inset 0 -6px 22px rgba(156,77,255,0.02);
    }

    html,body{height:100%; margin:0; font-family:Poppins,system-ui; background: radial-gradient(circle at 10% 10%, #07021b, #010007 60%); color:#e6faff}
    .container{max-width:1100px; margin:28px auto; padding:18px}

    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--glass-border); box-shadow: var(--neon-shadow)}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{ width:56px; height:56px; border-radius:12px; display:grid; place-items:center; font-family:Orbitron; font-weight:700; font-size:20px; background: linear-gradient(90deg,#00d7ff,#7f49ff); color:#030014; box-shadow:0 10px 30px rgba(0,240,255,0.12);}    
    .nav-actions{display:flex; gap:8px; align-items:center}
    .btn { border: none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; font-family:Orbitron; }
    .btn-ghost{ background: transparent; color:#aeefff; border:1px solid rgba(174,239,255,0.06) }
    .btn-primary{ background: linear-gradient(90deg,#00f0ff,#9c4dff); color:#050014; box-shadow:0 8px 30px rgba(156,77,255,0.06) }

    .main{display:grid; grid-template-columns: 1fr 360px; gap:18px; margin-top:18px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:16px; border:1px solid var(--glass-border); box-shadow:0 12px 40px rgba(0,0,0,0.4)}

    .listing-hero{display:flex; gap:18px; align-items:flex-start}
    .media{width:360px; height:220px; border-radius:10px; background:linear-gradient(90deg,#0b0b14,#060616); display:flex; align-items:center; justify-content:center; font-weight:700; color:#e8faff}

    .meta{flex:1}
    .meta h2{margin:0 0 6px; font-size:20px; color:#ddfaff}
    .meta .by{font-size:13px; color:#9fefff}
    .price{font-weight:900; font-size:20px; color:#9cffff; margin-top:8px}

    .tags{display:flex; gap:8px; margin-top:10px}
    .tag{padding:6px 8px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid rgba(255,255,255,0.03); font-size:13px}

    .description{margin-top:14px; color:#dff9ff}

    .seller-row{display:flex; gap:12px; align-items:center; margin-top:12px}
    .avatar{width:56px; height:56px; border-radius:10px; background:linear-gradient(90deg,#00d7ff,#7f49ff); display:grid; place-items:center; font-family:Orbitron; font-weight:700; color:#030014}

    .sidebar .panel{margin-bottom:12px}
    .buy-area{display:flex; gap:8px; align-items:center; margin-top:12px}
    .buy-btn{padding:12px 14px; border-radius:12px; background:linear-gradient(90deg,#00f0ff,#9c4dff); color:#050014; font-weight:900; border:none; cursor:pointer}

    .notes{margin-top:12px; font-size:13px; color:#bfefff}

    .reviews{margin-top:12px}
    .review{padding:10px; border-radius:8px; background:rgba(0,0,0,0.2); margin-bottom:8px}

    footer{margin-top:30px; text-align:center; color:#95e9ff; opacity:0.7; font-size:13px}

    @media(max-width:920px){
      .main{grid-template-columns:1fr}
      .media{width:100%; height:180px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">Z</div>
        <div>
          <div style="font-size:14px; opacity:0.95; font-family:Orbitron">ZepShop</div>
          <div style="font-size:12px; color:#9fefff; margin-top:4px">Student Marketplace — Listing</div>
        </div>
      </div>

      <div class="nav-actions">
        <div id="userInfo" class="balance-card" style="display:none">
          <div>
            <div style="font-size:12px; color:#9fefff">Connected</div>
            <strong id="walletShort">0x...abcd</strong>
          </div>
        </div>

        <button id="connectBtn" class="btn btn-primary">Connect Wallet</button>
        <button id="backBtn" class="btn btn-ghost" onclick="location.href='index.html'">Back to Marketplace</button>
      </div>
    </header>

    <div class="main">
      <div>
        <div class="card listing-hero">
          <div class="media" id="mediaEl">SERVICE</div>
          <div class="meta">
            <h2 id="title">Listing title</h2>
            <div class="by">by <span id="sellerShort">0x..seller</span></div>
            <div class="price" id="price">USDC 0.00</div>

            <div class="tags" id="tags"></div>

            <div class="seller-row">
              <div class="avatar" id="sellerAvatar">S</div>
              <div>
                <div style="font-weight:800" id="sellerName">Seller Student</div>
                <div class="small" id="sellerBio" style="color:#bfefff">Student seller • 3 gigs • 98% positive</div>
              </div>
            </div>

            <div class="description" id="description">Full description of the service. Includes deliverables, timeline, and what the buyer will receive.</div>

            <div class="notes">Delivery time: <strong id="delivery">24 hours</strong> • Revisions: <strong id="revisions">1</strong></div>
          </div>
        </div>

        <div class="card reviews">
          <h4 style="margin:0 0 8px">Reviews</h4>
          <div id="reviewsList">
            <!-- injected -->
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="card panel">
          <h4 style="margin:0 0 6px">Quick Buy</h4>
          <div style="color:#dff9ff; margin-top:6px">Pay the seller directly with USDC on Base. This demo uses a direct ERC-20 transfer (buyer → seller).</div>

          <div style="margin-top:12px">
            <label class="small">Buyer note (optional)</label>
            <textarea id="buyerNote" placeholder="Add a short message for the seller" style="width:100%; min-height:80px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:#e6faff"></textarea>
          </div>

          <div class="buy-area">
            <button id="buyBtn" class="buy-btn" disabled>Pay with USDC</button>
            <button id="previewBtn" class="btn btn-ghost">Preview</button>
          </div>

          <div class="small" style="margin-top:10px; color:#bfefff">Note: For production use a marketplace contract or escrow for safer dispute handling.</div>
        </div>

        <div class="card panel">
          <h4 style="margin:0 0 6px">Seller info</h4>
          <div style="display:flex; gap:8px; align-items:center">
            <div class="avatar">S</div>
            <div>
              <div style="font-weight:800">Seller Student</div>
              <div class="small">Member since 2024 • Response time: 6h</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <button id="messageBtn" class="btn btn-ghost">Message seller</button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      © <span id="year"></span> ZepShop — Zep Swipe. Built on Base.
    </footer>
  </div>

  <script>
    // --- Config (same as index) ---
    const ZAC_ADDRESS = '0xfe4119a9cac1425d808526905e92386b4234bf2a';
    const USDC_ADDRESS = 'USDC_ON_BASE_ADDRESS'; // replace
    const BASE_CHAIN_ID = 8453;

    // Reuse PRODUCTS example (in a real app you'd fetch the product by id)
    const PRODUCTS = [
      { id: 'p1', title: '1-hour Tutoring: Calculus', priceUSDC: 12.00, seller: '0xSELLERADDRESS1', desc: 'Live 1-hour tutoring session covering calculus topics. Includes notes and practice problems.', tags:['tutoring','math','calculus'], delivery:'1 hour', revisions:1 },
      { id: 'p2', title: 'Exam Notes — Marketing 101', priceUSDC: 5.00, seller: '0xSELLERADDRESS2', desc: 'Concise, syllabus-aligned exam notes for Marketing 101. PDF + study guide.', tags:['notes','marketing'], delivery:'6 hours', revisions:0 },
      { id: 'p3', title: 'Logo design (student starter pack)', priceUSDC: 15.00, seller: '0xSELLERADDRESS3', desc: '3 logo concepts, 2 revisions, source files included (SVG/PNG).', tags:['design','logo'], delivery:'48 hours', revisions:2 },
      { id: 'p4', title: 'Short coding gig — 1 page', priceUSDC: 8.50, seller: '0xSELLERADDRESS4', desc: 'Implement one static page with responsive layout. Includes basic accessibility.', tags:['web','frontend'], delivery:'24 hours', revisions:1 }
    ];

    // Small helper functions
    const qParams = new URLSearchParams(window.location.search);
    const getParam = (k, fallback=null) => qParams.get(k) || fallback;

    const formatUSDC = (v) => Number(v).toFixed(2);
    const short = (a) => a ? `${a.slice(0,6)}...${a.slice(-4)}` : '';

    // UI refs
    const connectBtn = document.getElementById('connectBtn');
    const userInfo = document.getElementById('userInfo');
    const walletShort = document.getElementById('walletShort');
    const buyBtn = document.getElementById('buyBtn');
    const previewBtn = document.getElementById('previewBtn');
    const messageBtn = document.getElementById('messageBtn');
    const sellerShort = document.getElementById('sellerShort');

    const titleEl = document.getElementById('title');
    const priceEl = document.getElementById('price');
    const descEl = document.getElementById('description');
    const tagsEl = document.getElementById('tags');
    const sellerAvatar = document.getElementById('sellerAvatar');
    const sellerName = document.getElementById('sellerName');
    const deliveryEl = document.getElementById('delivery');
    const revisionsEl = document.getElementById('revisions');
    const mediaEl = document.getElementById('mediaEl');
    const reviewsList = document.getElementById('reviewsList');

    let provider=null, signer=null, currentAddress=null;
    let product=null;

    document.getElementById('year').textContent = new Date().getFullYear();

    // get product id from querystring or fallback to p1
    const pid = getParam('id','p1');
    product = PRODUCTS.find(p => p.id === pid) || PRODUCTS[0];
    populateListing(product);

    function populateListing(p){
      titleEl.innerText = p.title;
      priceEl.innerText = `USDC ${formatUSDC(p.priceUSDC)}`;
      descEl.innerText = p.desc || '';
      deliveryEl.innerText = p.delivery || '24 hours';
      revisionsEl.innerText = p.revisions != null ? p.revisions : '—';
      sellerShort.innerText = short(p.seller);
      sellerAvatar.innerText = p.seller.slice(2,4).toUpperCase();
      sellerName.innerText = `Student ${p.seller.slice(2,6)}`;
      mediaEl.innerText = p.title.split(' ')[0].toUpperCase();

      tagsEl.innerHTML = '';
      (p.tags||[]).forEach(t => { const el = document.createElement('div'); el.className='tag'; el.innerText = t; tagsEl.appendChild(el); });

      // demo reviews
      const REVIEWS = [
        { name:'Alex', rating:5, text:'Great quality, fast delivery.' },
        { name:'Jamie', rating:4, text:'Good work — small revision requested.' }
      ];
      reviewsList.innerHTML = '';
      REVIEWS.forEach(r => {
        const d = document.createElement('div'); d.className='review';
        d.innerHTML = `<div style="font-weight:800">${r.name} — ${'★'.repeat(r.rating)}</div><div style="margin-top:6px">${r.text}</div>`;
        reviewsList.appendChild(d);
      });
    }

    // --- Wallet connect logic (similar to index) ---
    async function connectWallet(){
      try{
        if(!window.ethereum){ alert('No wallet detected. Install MetaMask or use Coinbase Wallet.'); return; }
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = await provider.getSigner();
        currentAddress = await signer.getAddress();

        // network check
        const net = await provider.getNetwork();
        if(net.chainId !== BASE_CHAIN_ID){
          try{
            await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: '0x' + BASE_CHAIN_ID.toString(16) }] });
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
          } catch(e){ console.warn('Chain switch failed', e); }
        }

        localStorage.setItem('zepUser', JSON.stringify({ wallet: currentAddress, loggedIn:true }));
        walletShort.innerText = short(currentAddress);
        userInfo.style.display = 'flex';
        connectBtn.style.display = 'none';
        buyBtn.disabled = false;

      } catch(e){ console.error(e); alert('Connection failed'); }
    }

    connectBtn.addEventListener('click', connectWallet);

    window.addEventListener('load', async ()=>{
      const user = JSON.parse(localStorage.getItem('zepUser')||'null');
      if(user && user.loggedIn && window.ethereum){ try{ await connectWallet(); }catch(e){/* ignore */} }
    });

    previewBtn.addEventListener('click', ()=>{
      alert(`Preview\n\n${product.title}\nPrice: USDC ${formatUSDC(product.priceUSDC)}\nSeller: ${short(product.seller)}`);
    });

    // buy flow (direct ERC-20 transfer)
    buyBtn.addEventListener('click', async ()=>{
      if(!signer) return alert('Connect wallet first');
      if(USDC_ADDRESS === 'USDC_ON_BASE_ADDRESS') return alert('USDC contract address not set. Replace USDC_ON_BASE_ADDRESS with the real USDC contract address on Base.');

      try{
        const erc20 = ["function transfer(address to, uint256 amount) returns (bool)", "function decimals() view returns (uint8)"];
        const usdc = new ethers.Contract(USDC_ADDRESS, erc20, signer);
        const decimals = await usdc.decimals().catch(()=>6);
        const amountUnits = ethers.parseUnits(String(product.priceUSDC), decimals);

        const ok = confirm(`Confirm: pay USDC ${formatUSDC(product.priceUSDC)} to seller ${short(product.seller)}?`);
        if(!ok) return;

        buyBtn.disabled = true; buyBtn.innerText = 'Processing...';
        const tx = await usdc.transfer(product.seller, amountUnits);
        await tx.wait();

        const note = document.getElementById('buyerNote').value||'';
        const hist = JSON.parse(localStorage.getItem('zepshop_purchases')||'[]');
        hist.unshift({ productId:product.id, txHash:tx.hash, note, time:Date.now(), buyer: currentAddress });
        localStorage.setItem('zepshop_purchases', JSON.stringify(hist));

        alert('Payment sent! TX: ' + tx.hash);
      }catch(e){ console.error(e); alert('Payment failed or rejected.'); }
      finally{ buyBtn.disabled=false; buyBtn.innerText='Pay with USDC'; }
    });

    // message seller (demo: prefilled email link or opens mailto)
    messageBtn.addEventListener('click', ()=>{
      const subject = encodeURIComponent('Question about your ZepShop listing: '+product.title);
      const body = encodeURIComponent('Hi — I have a question about your listing: '+product.title+' (id: '+product.id+').');
      window.location.href = `mailto:student@example.com?subject=${subject}&body=${body}`;
    });

  </script>
</body>
</html>
